<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Lab6</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	text-indent: -1.7em;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
}

.simple-table-header {
	background: rgb(247, 246, 243);
	color: black;
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(145, 145, 142, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(187, 132, 108, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(215, 129, 58, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 148, 51, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(108, 155, 125, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(91, 151, 189, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(167, 130, 195, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(205, 116, 159, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(225, 111, 100, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(145, 145, 142, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(187, 132, 108, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(215, 129, 58, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 148, 51, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(108, 155, 125, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(91, 151, 189, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(167, 130, 195, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(205, 116, 159, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(225, 111, 100, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="1854d6c2-c4f9-4872-9f21-112c10a9a462" class="page sans"><header><div class="page-header-icon undefined"><span class="icon">ğŸ¤ª</span></div><h1 class="page-title">Lab6</h1></header><div class="page-body"><p id="1568e49c-f082-49ac-a5d9-7bfd79f53bd7" class=""><mark class="highlight-red">åœ¨è®¡ç®—æœºç³»ç»Ÿä¸­æœ‰ä¸€ç§è¯´æ³•ï¼Œä»»ä½•ç³»ç»Ÿé—®é¢˜éƒ½å¯ä»¥ç”¨æŸç§ç¨‹åº¦çš„æŠ½è±¡æ–¹æ³•æ¥è§£å†³ã€‚Lazy allocationå®éªŒä¸­æä¾›äº†ä¸€ä¸ªä¾‹å­ã€‚è¿™ä¸ªå®éªŒæ¢ç´¢äº†å¦ä¸€ä¸ªä¾‹å­ï¼šå†™æ—¶å¤åˆ¶åˆ†æ”¯ï¼ˆcopy-on write forkï¼‰ã€‚</mark></p><p id="718aded8-788c-4845-868f-942f3fd86d4b" class="">è·Ÿç€æç¤ºä¸€æ­¥ä¸€æ­¥æ¥</p><p id="3e7307c4-145a-41a9-8851-d2900f72cbec" class=""><strong>(1).</strong>Â åœ¨<em><strong>kernel/riscv.h</strong></em>ä¸­é€‰å–PTEä¸­çš„ä¿ç•™ä½å®šä¹‰æ ‡è®°ä¸€ä¸ªé¡µé¢æ˜¯å¦ä¸ºCOW Forké¡µé¢çš„æ ‡å¿—ä½</p><pre id="88687823-e5a8-4d2b-a317-18fdbfd4e19e" class="code"><code>// è®°å½•åº”ç”¨äº†COWç­–ç•¥åforkçš„é¡µé¢
#define PTE_COW (1L &lt;&lt; 8)</code></pre><p id="edd588ff-1937-493f-a6e5-2cf8e0b315d0" class=""><strong>(2).</strong>Â åœ¨<em><strong>kalloc.c</strong></em>ä¸­è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹</p><ul id="043e19ac-f3ed-4296-9a25-811af0a9342f" class="bulleted-list"><li style="list-style-type:disc">å®šä¹‰å¼•ç”¨è®¡æ•°çš„å…¨å±€å˜é‡<code>ref</code>ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ä¸ªè‡ªæ—‹é”å’Œä¸€ä¸ªå¼•ç”¨è®¡æ•°æ•°ç»„ï¼Œç”±äº<code>ref</code>æ˜¯å…¨å±€å˜é‡ï¼Œä¼šè¢«è‡ªåŠ¨åˆå§‹åŒ–ä¸ºå…¨0ã€‚<p id="55e272ef-dde7-4659-b04f-d89e4a281293" class="">è¿™é‡Œä½¿ç”¨è‡ªæ—‹é”æ˜¯è€ƒè™‘åˆ°è¿™ç§æƒ…å†µï¼šè¿›ç¨‹P1å’ŒP2å…±ç”¨å†…å­˜Mï¼ŒMå¼•ç”¨è®¡æ•°ä¸º2ï¼Œæ­¤æ—¶CPU1è¦æ‰§è¡Œ<code>fork</code>äº§ç”ŸP1çš„å­è¿›ç¨‹ï¼ŒCPU2è¦ç»ˆæ­¢P2ï¼Œé‚£ä¹ˆå‡è®¾ä¸¤ä¸ªCPUåŒæ—¶è¯»å–å¼•ç”¨è®¡æ•°ä¸º2ï¼Œæ‰§è¡Œå®ŒæˆåCPU1ä¸­ä¿å­˜çš„å¼•ç”¨è®¡æ•°ä¸º3ï¼ŒCPU2ä¿å­˜çš„è®¡æ•°ä¸º1ï¼Œé‚£ä¹ˆåèµ‹å€¼çš„è¯­å¥ä¼šè¦†ç›–æ‰å…ˆèµ‹å€¼çš„è¯­å¥ï¼Œä»è€Œäº§ç”Ÿé”™è¯¯</p></li></ul><pre id="caf6d552-246a-4841-848d-699295ea6ab4" class="code"><code>struct ref_stru {
  struct spinlock lock;
  int cnt[PHYSTOP / PGSIZE];  // å¼•ç”¨è®¡æ•°
} ref;</code></pre><ul id="0f860dad-cecb-427a-84de-852b628de25d" class="bulleted-list"><li style="list-style-type:disc">åœ¨<code>kinit</code>ä¸­åˆå§‹åŒ–<code>ref</code>çš„è‡ªæ—‹é”</li></ul><p id="56ebafa7-0a4b-4b7a-bc03-e4d5f5183033" class="">å¯¹äºä¸Šä¸‹æ–‡æ“ä½œï¼Œè¿›ç¨‹è¦ä¸€ç›´ç­‰å¾…ï¼Œè‡ªæ—‹é”æœ‰è¿™ä¸ªç‰¹æ€§ã€‚</p><pre id="2bfd6de1-8093-4039-b4f0-7e303684bf5b" class="code"><code>void
kinit()
{
  initlock(&amp;kmem.lock, &quot;kmem&quot;);
  initlock(&amp;ref.lock, &quot;ref&quot;);
  freerange(end, (void*)PHYSTOP);
}</code></pre><ul id="eb124849-edac-45ca-9581-a89a4ca79532" class="bulleted-list"><li style="list-style-type:disc">ä¿®æ”¹<code>kalloc</code>å’Œ<code>kfree</code>å‡½æ•°ï¼Œåœ¨<code>kalloc</code>ä¸­åˆå§‹åŒ–å†…å­˜å¼•ç”¨è®¡æ•°ä¸º1ï¼Œåœ¨<code>kfree</code>å‡½æ•°ä¸­å¯¹å†…å­˜å¼•ç”¨è®¡æ•°å‡1ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°ä¸º0æ—¶æ‰çœŸæ­£åˆ é™¤</li></ul><pre id="0c1e0702-537d-4445-ba4f-2acad6913805" class="code"><code>void
kfree(void *pa)
{
  struct run *r;

  if(((uint64)pa % PGSIZE) != 0 || (char*)pa &lt; end || (uint64)pa &gt;= PHYSTOP)
    panic(&quot;kfree&quot;);

  // åªæœ‰å½“å¼•ç”¨è®¡æ•°ä¸º0äº†æ‰å›æ”¶ç©ºé—´
  // å¦åˆ™åªæ˜¯å°†å¼•ç”¨è®¡æ•°å‡1
  acquire(&amp;ref.lock);
  if(--ref.cnt[(uint64)pa / PGSIZE] == 0) {
    release(&amp;ref.lock);

    r = (struct run*)pa;

    // Fill with junk to catch dangling refs.
    memset(pa, 1, PGSIZE);

    acquire(&amp;kmem.lock);
    r-&gt;next = kmem.freelist;
    kmem.freelist = r;
    release(&amp;kmem.lock);
  } else {
    release(&amp;ref.lock);
  }
}


void *
kalloc(void)
{
  struct run *r;

  acquire(&amp;kmem.lock);
  r = kmem.freelist;
  if(r) {
    kmem.freelist = r-&gt;next;
    acquire(&amp;ref.lock);
    ref.cnt[(uint64)r / PGSIZE] = 1;  // å°†å¼•ç”¨è®¡æ•°åˆå§‹åŒ–ä¸º1
    release(&amp;ref.lock);
  }
  release(&amp;kmem.lock);

  if(r)
    memset((char*)r, 5, PGSIZE); // fill with junk
  return (void*)r;
}</code></pre><ul id="241f0347-b8e3-45d7-85cf-2b07dafe5675" class="bulleted-list"><li style="list-style-type:disc">vm.cä¸­æ·»åŠ å¦‚ä¸‹å››ä¸ªå‡½æ•°ï¼Œè¯¦ç»†è¯´æ˜å·²åœ¨æ³¨é‡Šä¸­ï¼Œè¿™äº›å‡½æ•°ä¸­ç”¨åˆ°äº†<code>walk</code>ï¼Œè®°å¾—åœ¨<em><strong>defs.h</strong></em>ä¸­æ·»åŠ å£°æ˜ï¼Œæœ€åä¹Ÿéœ€è¦å°†è¿™äº›å‡½æ•°çš„å£°æ˜æ·»åŠ åˆ°<em><strong>defs.h</strong></em>ï¼Œåœ¨cowallocä¸­ï¼Œè¯»å–å†…å­˜å¼•ç”¨è®¡æ•°ï¼Œå¦‚æœä¸º1ï¼Œè¯´æ˜åªæœ‰å½“å‰è¿›ç¨‹å¼•ç”¨äº†è¯¥ç‰©ç†å†…å­˜ï¼ˆå…¶ä»–è¿›ç¨‹æ­¤å‰å·²ç»è¢«åˆ†é…åˆ°äº†å…¶ä»–ç‰©ç†é¡µé¢ï¼‰ï¼Œå°±åªéœ€è¦æ”¹å˜PTEä½¿èƒ½<code>PTE_W</code>ï¼›å¦åˆ™å°±åˆ†é…ç‰©ç†é¡µé¢ï¼Œå¹¶å°†åŸæ¥çš„å†…å­˜å¼•ç”¨è®¡æ•°å‡1ã€‚è¯¥å‡½æ•°éœ€è¦è¿”å›ç‰©ç†åœ°å€ï¼Œè¿™å°†åœ¨<code>copyout</code>ä¸­ä½¿ç”¨åˆ°ã€‚</li></ul><pre id="f33480b2-65b8-488e-a8a3-231aa9c3b62c" class="code"><code>int             
cowpage(uint64 va){
    pte_t *pte;
  struct proc *p = myproc();
  
  return ( va &lt; p-&gt;sz )// åœ¨è¿›ç¨‹å†…å­˜èŒƒå›´å†…
    &amp;&amp; ((pte = walk(p-&gt;pagetable, va, 0))!=0)
    &amp;&amp; (*pte &amp; (PTE_COW | PTE_V)); //é¡µè¡¨é¡¹å­˜åœ¨ä¸”å¯¹åº”çš„æ˜¯ä¸€ä¸ªlazy allocationé¡µ
}

/**
 * @brief cowalloc copy-on-writeåˆ†é…å™¨
 * @param pagetable æŒ‡å®šé¡µè¡¨
 * @param va æŒ‡å®šçš„è™šæ‹Ÿåœ°å€,å¿…é¡»é¡µé¢å¯¹é½
 * @return åˆ†é…åvaå¯¹åº”çš„ç‰©ç†åœ°å€ï¼Œå¦‚æœè¿”å›0åˆ™åˆ†é…å¤±è´¥
 */
void*           
cowalloc(uint64 va){
  pte_t* pte;
  struct proc *p = myproc();
  uint64 pa ;
  if(va % PGSIZE != 0)
    return 0;
    // panic(&quot;cowalloc:PGSIZE&quot;);
  /* è·å–å¯¹åº”çš„ç‰©ç†åœ°å€ */
  if((pa = walkaddr(p-&gt;pagetable, va)) == 0)
    return 0;
    // panic(&quot;cowalloc:walkaddr&quot;);
  /* è·å–å¯¹åº”çš„pte */
  pte = walk(p-&gt;pagetable, va, 0);

  if(krefcnt((char*)pa) == 1){
    /* åªå‰©ä¸‹ä¸€ä¸ªè¿›ç¨‹å¼•ç”¨ï¼Œç›´æ¥æ›´æ”¹æƒé™ */
    *pte |= PTE_W;
    *pte &amp;= ~PTE_COW;
    return (void*)pa;
  }else{
    /* å¤šä¸ªè¿›ç¨‹å¼•ç”¨è¯¥ç‰©ç†åœ°å€ */
    char* mem;
    if( (mem = kalloc()) == 0)
      return 0;
      // panic(&quot;cowalloc: kalloc&quot;);
    // å¤åˆ¶æ—§é¡µé¢å†…å®¹åˆ°æ–°é¡µ
    memmove(mem, (char*)pa, PGSIZE);
    // æ¸…é™¤PTE_Vï¼Œå¦åˆ™åœ¨mappaggesä¸­ä¼šåˆ¤å®šä¸ºremap
     *pte &amp;= ~PTE_V;

    // ä¸ºæ–°é¡µé¢æ·»åŠ æ˜ å°„
    if(mappages(p-&gt;pagetable, va, PGSIZE, (uint64)mem, (PTE_FLAGS(*pte) | PTE_W) &amp; ~PTE_COW) != 0) {
      kfree(mem);
      *pte |= PTE_V;
      // panic(&quot;cowalloc : mappages&quot;);
      return 0;
    }

    // å°†åŸæ¥çš„ç‰©ç†å†…å­˜å¼•ç”¨è®¡æ•°å‡1
    kfree((char*)PGROUNDDOWN(pa));
    return mem;
  }

}

/**
 * @brief krefcnt è·å–å†…å­˜çš„å¼•ç”¨è®¡æ•°
 * @param pa æŒ‡å®šçš„å†…å­˜åœ°å€
 * @return å¼•ç”¨è®¡æ•°
 */
int krefcnt(void* pa) {
  return ref.cnt[(uint64)pa / PGSIZE];
}

/**
 * @brief kaddrefcnt å¢åŠ å†…å­˜çš„å¼•ç”¨è®¡æ•°
 * @param pa æŒ‡å®šçš„å†…å­˜åœ°å€
 * @return 0:æˆåŠŸ -1:å¤±è´¥
 */
int kaddrefcnt(void* pa) {
  if(((uint64)pa % PGSIZE) != 0 || (char*)pa &lt; end || (uint64)pa &gt;= PHYSTOP)
    return -1;
  acquire(&amp;ref.lock);
  ++ref.cnt[(uint64)pa / PGSIZE];
  release(&amp;ref.lock);
  return 0;
}</code></pre><ul id="be77a3c0-74cd-419e-9c1a-0a1c2d5f6de7" class="bulleted-list"><li style="list-style-type:disc">ä¿®æ”¹<code>freerange</code></li></ul><pre id="7ea5047c-16b4-45fd-bfae-cf27b041adb4" class="code"><code>void
freerange(void *pa_start, void *pa_end)
{
  char *p;
  p = (char*)PGROUNDUP((uint64)pa_start);
  for(; p + PGSIZE &lt;= (char*)pa_end; p += PGSIZE) {
    // åœ¨kfreeä¸­å°†ä¼šå¯¹cnt[]å‡1ï¼Œè¿™é‡Œè¦å…ˆè®¾ä¸º1ï¼Œå¦åˆ™å°±ä¼šå‡æˆè´Ÿæ•°
    ref.cnt[(uint64)p / PGSIZE] = 1;
    kfree(p);
  }
}</code></pre><p id="7ab04611-da89-4732-bdb7-25936f1a904b" class=""><strong>(3).</strong>Â ä¿®æ”¹<code>uvmcopy</code>ï¼Œä¸ä¸ºå­è¿›ç¨‹åˆ†é…å†…å­˜ï¼Œè€Œæ˜¯ä½¿çˆ¶å­è¿›ç¨‹å…±äº«å†…å­˜ï¼Œä½†ç¦ç”¨<code>PTE_W</code>ï¼ŒåŒæ—¶æ ‡è®°<code>PTE_F</code>ï¼Œè®°å¾—è°ƒç”¨<code>kaddrefcnt</code>å¢åŠ å¼•ç”¨è®¡æ•°</p><pre id="bad75ef9-71ca-4295-b4ab-213ca63bdccb" class="code"><code>// Given a parent process&#x27;s page table, copy
// its memory into a child&#x27;s page table.
// Copies both the page table and the
// physical memory.
// returns 0 on success, -1 on failure.
// frees any allocated pages on failure.
int
uvmcopy(pagetable_t old, pagetable_t new, uint64 sz)
{
  pte_t *pte;
  uint64 pa, i;
  uint flags;
  // char *mem;

  for(i = 0; i &lt; sz; i += PGSIZE){
    if((pte = walk(old, i, 0)) == 0)
      panic(&quot;uvmcopy: pte should exist&quot;);
    if((*pte &amp; PTE_V) == 0)
      panic(&quot;uvmcopy: page not present&quot;);
    pa = PTE2PA(*pte);
    /* ä¿®æ”¹çˆ¶è¿›ç¨‹ã€å­è¿›ç¨‹å¶å­pteæ ‡å¿—ä½ */
    *pte = (*pte &amp; ~PTE_W) | PTE_COW;
    flags = PTE_FLAGS(*pte);
    /*ä¸æ‹·è´ç‰©ç†å†…å­˜ */
    // if((mem = kalloc()) == 0)
      // goto err;
    // memmove(mem, (char*)pa, PGSIZE);
    if(mappages(new, i, PGSIZE, pa, flags) != 0){
      // kfree(pa);
      goto err;
    }
  /* å¢åŠ ç‰©ç†é¡µå¼•ç”¨æ¬¡æ•° */
    kaddrefcnt((char*)pa);
  }

  return 0;

 err:
  uvmunmap(new, 0, i / PGSIZE, 1);
  return -1;
}</code></pre><p id="c9dffc78-d1ea-45cb-935b-9de836cda7e3" class=""><strong>(4).</strong>Â ä¿®æ”¹<code>usertrap</code>ï¼Œå¤„ç†é¡µé¢é”™è¯¯</p><pre id="3a2e977f-3d17-47d4-8d0e-2e5c4f4e83ee" class="code"><code>uint64 cause = r_scause();
if(cause == 8) {
  ...
} else if((which_dev = devintr()) != 0){
  // ok
} else if(cause == 13 || cause == 15) {
  uint64 fault_va = r_stval();  // è·å–å‡ºé”™çš„è™šæ‹Ÿåœ°å€
  if(fault_va &gt;= p-&gt;sz
    || cowpage(p-&gt;pagetable, fault_va) != 1
    || cowalloc(p-&gt;pagetable, PGROUNDDOWN(fault_va)) == 0)
    p-&gt;killed = 1;
} else {
  ...
}</code></pre><p id="f6ab31f6-fc01-4172-bd64-32fc7af0963a" class=""><strong>(5).</strong>Â åœ¨<code>copyout</code>ä¸­å¤„ç†ç›¸åŒçš„æƒ…å†µï¼Œå¦‚æœæ˜¯COWé¡µé¢ï¼Œéœ€è¦æ›´æ¢<code>pa0</code>æŒ‡å‘çš„ç‰©ç†åœ°å€</p><pre id="409e1ba2-3783-4bf2-adbf-27f7a4311fcb" class="code"><code>while(len &gt; 0){
  va0 = PGROUNDDOWN(dstva);
  pa0 = walkaddr(pagetable, va0);

  // å¤„ç†COWé¡µé¢çš„æƒ…å†µ
  if(cowpage(pagetable, va0)) {
    // æ›´æ¢ç›®æ ‡ç‰©ç†åœ°å€
    pa0 = (uint64)cowalloc(pagetable, va0);
  }

  if(pa0 == 0)
    return -1;

  ...
}</code></pre></div></article></body></html>